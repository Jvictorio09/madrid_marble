{% extends "dashboard/base.html" %}

{% block title %}Image Gallery - Madrid Marble Dashboard{% endblock %}

{% block content %}
<!-- Include Image Picker Modal -->
{% include "dashboard/image_picker_modal.html" %}
<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-4xl font-bold text-navy-900">Image Gallery</h1>
        <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" 
                class="bg-navy-900 text-white px-6 py-3 rounded-xl font-semibold hover:bg-navy-950 transition">
            <i class="fa-solid fa-upload mr-2"></i> Upload Image
        </button>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-navy-900">Upload Image</h2>
                <button onclick="document.getElementById('upload-modal').classList.add('hidden')" 
                        class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Select Image</label>
                    <input type="file" name="file" id="file-input" accept="image/*" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-navy-900 focus:outline-none focus:ring-2 focus:ring-navy-900/20">
                    <p class="text-sm text-gray-500 mt-2">Max file size: 10MB. Images will be automatically compressed.</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Folder (optional)</label>
                    <input type="text" name="folder" id="folder-input" value="madrid_marble/uploads" 
                           placeholder="madrid_marble/uploads"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-navy-900 focus:outline-none focus:ring-2 focus:ring-navy-900/20">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tags (comma-separated, optional)</label>
                    <input type="text" name="tags" id="tags-input" 
                           placeholder="hero, homepage, project"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-navy-900 focus:outline-none focus:ring-2 focus:ring-navy-900/20">
                </div>
                <div id="upload-progress" class="hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-navy-900 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Uploading and processing image...</p>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-navy-900 text-white px-6 py-3 rounded-xl font-semibold hover:bg-navy-950 transition">
                        Upload
                    </button>
                    <button type="button" onclick="document.getElementById('upload-modal').classList.add('hidden')" 
                            class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gallery Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for asset in assets %}
        <div class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition"
             data-asset-id="{{ asset.id }}"
             data-asset-title="{{ asset.title }}"
             data-asset-web-url="{{ asset.web_url }}"
             data-asset-thumb-url="{{ asset.thumb_url }}"
             data-asset-secure-url="{{ asset.secure_url }}">
            <div class="relative aspect-video bg-gray-100">
                <img src="{{ asset.thumb_url }}" alt="{{ asset.title }}" class="w-full h-full object-cover">
                <div class="absolute top-2 right-2 flex gap-2">
                    <button onclick="copyToClipboard('{{ asset.web_url }}')" 
                            class="bg-white/90 hover:bg-white p-2 rounded-full shadow-sm" 
                            title="Copy URL">
                        <i class="fa-solid fa-copy text-sm text-navy-900"></i>
                    </button>
                    <a href="{{ asset.web_url }}" target="_blank" 
                       class="bg-white/90 hover:bg-white p-2 rounded-full shadow-sm" 
                       title="Open in new tab">
                        <i class="fa-solid fa-external-link-alt text-sm text-navy-900"></i>
                    </a>
                </div>
            </div>
            <div class="p-4">
                <h3 class="font-semibold text-navy-900 mb-1 truncate">{{ asset.title }}</h3>
                <p class="text-xs text-gray-500 mb-2">{{ asset.width }} × {{ asset.height }} • {{ asset.format|upper }}</p>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-600">{{ asset.bytes_size|filesizeformat }}</span>
                    <input type="text" value="{{ asset.web_url }}" readonly 
                           class="hidden" id="url-{{ asset.id }}">
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12">
            <i class="fa-solid fa-images text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-600">No images uploaded yet</p>
            <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" 
                    class="mt-4 bg-navy-900 text-white px-6 py-3 rounded-xl font-semibold hover:bg-navy-950 transition">
                Upload Your First Image
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Upload form handler
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('file-input');
    const folderInput = document.getElementById('folder-input');
    const tagsInput = document.getElementById('tags-input');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    
    if (!fileInput.files[0]) {
        alert('Please select an image file');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('folder', folderInput.value || 'madrid_marble/uploads');
    if (tagsInput.value) {
        formData.append('tags', tagsInput.value);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Show progress
    progressDiv.classList.remove('hidden');
    progressBar.style.width = '50%';
    
    try {
        const response = await fetch('{% url "dashboard:upload_image" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            progressBar.style.width = '100%';
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert('Upload failed: ' + data.error);
            progressDiv.classList.add('hidden');
        }
    } catch (error) {
        alert('Upload error: ' + error.message);
        progressDiv.classList.add('hidden');
    }
});

// Copy URL to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('URL copied to clipboard!');
    }).catch(err => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('URL copied to clipboard!');
    });
}
</script>
{% endblock %}

